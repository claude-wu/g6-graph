!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.welabxG6=t():e.welabxG6=t()}(window,(function(){return function(e){var t={};function a(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,a),n.l=!0,n.exports}return a.m=e,a.c=t,a.d=function(e,t,o){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(a.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(o,n,function(t){return e[t]}.bind(null,n));return o},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t,a){"use strict";function o(e,t,a,o){e.attr(t),a&&a.attr(o)}function n(e,t,a="hover"){const o=t.get("item"),n=t.getFirst().attr(),r="node"===e?o.get("originStyle"):o.get("originStyle")["edge-shape"],s=n[`${e}State:${a}`],i=n[e+"State:default"];return"edge"===e&&i&&null==i.lineWidth&&(i.lineWidth=1),{activeStyle:s,defaultStyle:i,originStyle:r}}a.r(t);const r={anchorShow(e,t){if(t.get("children")){const{anchorControls:e}=t.get("children")[0].cfg.attrs;if(e&&e.hide)return!1}e?t.showAnchor(t):t.clearAnchor(t)},anchorActived(e,t){if(t.get("children")){const{anchorControls:e}=t.get("children")[0].cfg.attrs;if(e&&e.hide)return!1}if(e){const e=t.get("item").getModel(),{anchorPoints:a,anchorHotsoptStyles:o}=e;t.showAnchor(t),this.getAnchorPoints({anchorPoints:a}).forEach((e,a)=>{const n=t.get("children")[0].getBBox(),r=t.addShape("circle",{zIndex:0,attrs:{x:n.minX+n.width*e[0],y:n.minY+n.height*e[1],r:0,opacity:.5,fill:"#1890ff",...o},nodeId:t.get("item").get("id"),className:"node-anchor-bg",draggable:!0,isAnchor:!0,index:a});r.animate({r:11},{duration:200}),t.sort(),t.anchorShapes.push(r)}),t.anchorShapes.filter(e=>{"node-anchor"===e.get("className")&&e.toFront(),"node-anchor-group"===e.get("className")&&(e.attr({r:(o&&o.r||11)+2}),e.toFront())})}else t.clearAnchor(t)},nodeState(e,t){!1===e?r["nodeState:default"].call(this,!0,t):r["nodeState:"+e]&&r["nodeState:"+e].call(this,e,t)},"nodeState:default"(e,t){if(e){const e=t.getChildByIndex(0),a=t.getChildByIndex(1),{defaultStyle:r}=n.call(this,"node",t);if(!r)return;o(e,r,a,r.labelCfg&&r.labelCfg.style?r.labelCfg.style:{})}},"nodeState:selected"(e,t){const a=t.getChildByIndex(0),r=t.getChildByIndex(1),{activeStyle:s,defaultStyle:i}=n.call(this,"node",t,"selected");if(s)if(e){o(a,s,r,s.labelCfg&&s.labelCfg.style?s.labelCfg.style:{})}else{o(a,i,r,i.labelCfg&&i.labelCfg.style?i.labelCfg.style:{})}},"nodeState:hover"(e,t){const a=t.getChildByIndex(0),{activeStyle:r,defaultStyle:s}=n.call(this,"node",t,"hover");r&&o(a,e?r:s)},edgeState(e,t){!1===e?r["edgeState:default"].call(this,!0,t):r["edgeState:"+e]&&r["edgeState:"+e].call(this,e,t)},"edgeState:default"(e,t){if(e){const{activeStyle:e,defaultStyle:a,originStyle:r}=n.call(this,"edge",t),s=t.getChildByIndex(0),{endArrow:i,startArrow:d}=s.get("attrs");a&&(this.stopAnimate(t,e&&e.animationType?e.animationType:"dash"),o(s,{...a,animationType:e.animationType||"dash"}),i&&s.attr("endArrow",!0===i||{path:i.path,fill:a.stroke||r.stroke}),d&&s.attr("startArrow",!0===d||{path:d.path,fill:a.stroke||r.stroke}))}},"edgeState:hover"(e,t){const a=t.getChildByIndex(0),{endArrow:r,startArrow:s}=a.get("attrs"),{activeStyle:i,defaultStyle:d,originStyle:l}=n.call(this,"edge",t,"hover");i&&(e?!0===i.animate?this.runAnimate(t,i.animationType||"dash"):"function"==typeof i.animate?i.animate.call(this,t):(o(a,i),r&&a.attr("endArrow",!0===r||{path:r.path,fill:i.stroke||l.stroke}),s&&a.attr("startArrow",!0===s||{path:s.path,fill:i.stroke||l.stroke})):!0===i.animate?this.stopAnimate(t,i.animationType||"dash"):"function"==typeof i.animate?i.animate.call(this,t,"stop"):(o(a,d),r&&a.attr("endArrow",!0===r||{path:r.path,fill:d.stroke||i.stroke||l.stroke}),s&&a.attr("startArrow",!0===s||{path:s.path,fill:d.stroke||i.stroke||l.stroke})))},"edgeState:selected"(e,t){const a=t.getChildByIndex(0),{endArrow:r,startArrow:s}=a.get("attrs"),{activeStyle:i,defaultStyle:d,originStyle:l}=n.call(this,"edge",t,"selected");i&&(e?!0===i.animate?this.runAnimate(t,i.animationType||"dash"):"function"==typeof i.animate?i.animate.call(this,t):(o(a,i),r&&a.attr("endArrow",!0===r||{path:r.path,fill:i.stroke||l.stroke}),s&&a.attr("startArrow",!0===s||{path:s.path,fill:i.stroke||l.stroke})):!0===i.animate?this.stopAnimate(t,i.animationType||"dash"):"function"==typeof i.animate?i.animate.call(this,t,"stop"):(o(a,d),r&&a.attr("endArrow",!0===r||{path:r.path,fill:d.stroke||i.stroke||l.stroke}),s&&a.attr("startArrow",!0===s||{path:s.path,fill:d.stroke||i.stroke||l.stroke})))}};var s=r;let i=[],d=1,l=null;var h={nodeStyles:{fill:"#ecf3ff",stroke:"#1890FF",lineWidth:1},nodeStateStyles:{"nodeState:default":{fill:"#ecf3ff"},"nodeState:hover":{cursor:"pointer",shadowOffsetX:0,shadowOffsetY:4,shadowBlur:10,opacity:.8},"nodeState:selected":{stroke:"#1890FF",cursor:"default"}},nodeLabelStyles:{style:{fontSize:12,fill:"#666",textAlign:"center",textBaseline:"middle",cursor:"default"}},nodeLabelStateStyles:{"nodeLabelState:default":{},"nodeLabelState:hover":{},"nodeLabelState:selected":{}},iconStyles:{width:20,height:20,x:0,y:0},edgeStyles:{stroke:"#aab7c3",lineAppendWidth:10,startArrow:{path:"M 0,0 L 8,4 L 7,0 L 8,-4 Z",fill:"#aab7c3"},endArrow:{path:"M 0,0 L 8,4 L 7,0 L 8,-4 Z",fill:"#aab7c3"}},edgeStateStyles:{selected:{stroke:"#aab7c3"},hover:{stroke:"#aab7c3"}},anchorPointStyles:{r:4,fill:"#fff",stroke:"#1890FF",lineWidth:1}};const{iconStyles:g,nodeStyles:c,anchorPointStyles:f,nodeLabelStyles:u}=h;function p(e,t){return{...t,...c,...e,...t.style,labelCfg:{...u,...t.labelCfg},iconStyles:{...g,...t.iconStyles},anchorPointStyles:{...f,...t.anchorPointStyles},...t.nodeStateStyles,anchorHotsoptStyles:t.anchorHotsoptStyles}}var y=e=>{e.registerNode("base-node",{getShapeStyle(e){const t=e.style.width||80,a=e.style.height||40;return p.call(this,{width:t,height:a,radius:5,x:-t/2,y:-a/2},e)},drawIcon(e,t,a){const{logoIcon:o,stateIcon:n}=a;[o,n].forEach((e,o)=>{if(e){const n=`${a.type}-${0===o?"logoIcon":"stateIcon"}`;let r=t.$getItem(n);if(!r){t.addShape(e.img?"image":"text",{attrs:{...e,...e.style},draggable:!0,className:n}).toFront(),r=t.$getItem(n)}r&&(e.show?r.show():r.hide())}})},initAnchor(e,t){t.anchorShapes=[],t.showAnchor=()=>{this.drawAnchor(e,t)},t.clearAnchor=()=>{if(t.anchorShapes){const e=t.$getItem("dashed-line");e&&e.remove(),t.anchorShapes.forEach(e=>e.remove())}t.anchorShapes=[]}},drawAnchor(e,t){const{type:a,direction:o,anchorPointStyles:n}=t.getFirst().attr(),r=t.get("children")[0].getBBox(),s=this.getAnchorPoints(e);s&&s.forEach((e,s)=>{const h="triangle-node"===a?"up"===o?1:0:.5,g=r.width*(e[0]-.5),c=r.height*(e[1]-h),f=t.addShape("circle",{attrs:{x:g,y:c,...n},zIndex:1,nodeId:t.get("id"),className:"node-anchor",draggable:!0,isAnchor:!0,index:s}),u=t.addShape("circle",{attrs:{x:g,y:c,r:11,fill:"#000",opacity:0},zIndex:2,nodeId:t.get("id"),className:"node-anchor-group",draggable:!0,isAnchor:!0,index:s});((e,t,a)=>{e.on("mouseenter",()=>{e.attr({cursor:"crosshair"})}),e.on("dragstart",e=>{const{type:o,direction:n}=t.getFirst().attr(),r="triangle-node"===o?"up"===n?1:0:.5,s=t.get("item").getBBox(),h=t.get("item").get("id"),g=[s.width*(a[0]-.5),s.height*(a[1]-r)];i=[e.x,e.y];const c=t.addShape("path",{attrs:{stroke:"#1890FF",lineDash:[5,5],path:[["M",...g],["L",...g]]},className:"dashed-line",pointStart:g});t.toFront(),c.toFront(),l=h,d=window.$welabxG6?window.$welabxG6.getZoom():1}),e.on("drag",e=>{const a=t.$getItem("dashed-line"),{type:o,direction:n}=t.getFirst().attr(),r=t.get("children")[0].get("canvasBBox");if(!r||!a)return;const s="triangle-node"===o?"up"===n?r.height:0:r.height/2,l=a.get("pointStart"),h=[(e.x-r.x-r.width/2)/d,(e.y-r.y-s)/d];a.toFront(),Math.sqrt(Math.pow(Math.abs(i[0])-Math.abs(e.x),2)+Math.pow(Math.abs(i[1])-Math.abs(e.y),2))>=10&&(e.x>=i[0]?(e.y,i[1],h[0]-=1,h[1]-=1):(e.y,i[1],h[0]+=1,h[1]+=1)),a.attr({path:[["M",...l],["L",h[0],h[1]]]})}),e.on("dragend",e=>{t.$getItem("dashed-line").remove(),l=null}),e.on("dragenter",e=>{if(e.target.cfg.nodeId!==l){const{index:a}=e.target.cfg;t.getAllAnchorBg()[a]&&t.getAllAnchorBg()[a].attr("fillOpacity",.7)}}),e.on("dragleave",e=>{if(e.target.cfg.nodeId!==l){const{index:a}=e.target.cfg;t.getAllAnchorBg()[a]&&t.getAllAnchorBg()[a].attr("fillOpacity",.5)}})})(u,t,e),t.anchorShapes.push(f),t.anchorShapes.push(u)}),t.getAllAnchors=()=>t.anchorShapes.filter(e=>!0===e.get("isAnchor")),t.getAnchor=e=>t.anchorShapes.filter(t=>"node-anchor"===t.get("className")&&t.get("index")===e),t.getAllAnchorBg=()=>t.anchorShapes.filter(e=>"node-anchor-bg"===e.get("className"))},addLabel(e,t,a){const{label:o,labelCfg:n,labels:r}=a;if(r)r.forEach(e=>{const{label:a,labelCfg:{maxlength:o},className:n}=e;let r=o?a.substr(0,o):a||"";a.length>o&&(r+="..."),t.addShape("text",{attrs:{text:r,...e,...e.labelCfg,...e.labelCfg.style},className:"node-text "+n,draggable:!0})});else if(o){const{maxlength:e}=n;let a=e?o.substr(0,e):o||"";o.length>e&&(a+="..."),t.addShape("text",{attrs:{text:a,x:0,y:0,...n,...n.style},className:"node-text",draggable:!0})}},drawModelRect(e,t){const{preRect:a,width:o,height:n}=t,r={show:!0,width:4,fill:"#40a9ff",radius:2};a&&!1===a.show||e.addShape("rect",{attrs:{x:-o/2,y:-n/2,height:n,...r,...a},draggable:!0})},draw(e,t){return this.drawShape(e,t)},drawShape(e,t){const a=this.getShapeStyle(e,t),o=t.addShape(this.shapeType,{className:this.shapeType+"-shape",xShapeNode:!0,draggable:!0,attrs:a});return t.$getItem=e=>t.get("children").find(t=>t.get("className")===e),"modelRect-node"===this.type&&this.drawModelRect(t,a),this.addLabel(e,t,a),this.drawIcon(e,t,a),this.initAnchor(e,t),o},update(e,t){const a=t.get("model"),{attrs:o}=t.get("keyShape"),n=t.get("group"),r=n.$getItem("node-text"),s=n.get("children")[0];if(r&&r.attr({text:a.label,...a.labelCfg.style}),"diamond-node"===o.type){const e=this.getPath({style:{size:a.size}});s.attr({...o,...a.style,path:e,width:a.size[0],height:a.size[1]})}else{const e=n.get("children").find(e=>e.cfg.className===o.type+"-logoIcon");e&&e.attr({...a.logoIcon});const t=n.get("children").find(e=>e.cfg.className===o.type+"-stateIcon");t&&t.attr({...a.stateIcon}),s.attr({...o,...a.style})}},setState(e,t,a){const o=a.getContainer();o.get("destroyed")||(["anchorShow","anchorActived","nodeState","nodeState:default","nodeState:selected","nodeState:hover","nodeOnDragStart","nodeOnDrag","nodeOnDragEnd"].includes(e)?s[e].call(this,t,o):this.stateApplying?this.stateApplying.call(this,e,t,a):console.warn(`warning: ${e} 事件回调未注册!\n可继承该节点并通过 stateApplying 方法进行注册\n如已注册请忽略 (-_-!)`))},getAnchorPoints:e=>e.anchorPoints||[[.5,0],[1,.5],[.5,1],[0,.5]]},"single-node")};const{iconStyles:S,nodeStyles:m,anchorPointStyles:x,nodeLabelStyles:v}=h;function b(e,t){return{...t,...m,...e,...t.style,labelCfg:{...v,...t.labelCfg,style:{...v.style,...t.labelCfg?t.labelCfg.style:{}}},iconStyles:{...S,...t.iconStyles},anchorPointStyles:{...x,...t.anchorPointStyles},...t.nodeStateStyles,anchorHotsoptStyles:t.anchorHotsoptStyles}}var w=e=>{e.registerNode("rect-node",{shapeType:"rect",getShapeStyle(e){const t=e.style.width||80,a=e.style.height||40;return b.call(this,{width:t,height:a,radius:5,x:-t/2,y:-a/2},e)}},"base-node"),e.registerNode("circle-node",{shapeType:"circle",getShapeStyle(e){const t=e.style.r||30;return b.call(this,{r:t,x:0,y:0},e)}},"base-node"),e.registerNode("ellipse-node",{shapeType:"ellipse",getShapeStyle(e){return b.call(this,{rx:50,ry:30,x:0,y:0},e)}},"base-node"),e.registerNode("modelRect-node",{shapeType:"rect",getShapeStyle(e){const t=e.style.width||200,a=e.style.height||80;return b.call(this,{width:t,height:a,radius:5,x:-t/2,y:-a/2},e)}},"base-node"),e.registerNode("diamond-node",{shapeType:"path",getShapeStyle(e){const t=this.getPath(e);return b.call(this,{path:t,x:0,y:0},e)},getPath(e){const t=e.style.size||[100,100],a=t[0],o=t[1];return[["M",0,-o/2],["L",a/2,0],["L",0,o/2],["L",-a/2,0],["Z"]]}},"base-node"),e.registerNode("triangle-node",{shapeType:"path",getShapeStyle(e){const t=this.getPath(e);return b.call(this,{direction:e.direction||"up",path:t,x:0,y:0},e)},getPath(e){const t=e.direction||"up",a=e.style.size||[60,100],o=a[0],n=a[1],r=[["Z"]];return"up"===t?r.unshift(["M",0,-n/2],["L",-o/2,0],["L",o/2,0]):r.unshift(["M",0,n/2],["L",-o/2,0],["L",o/2,0]),r},getAnchorPoints:e=>e.anchorPoints||[[.5,0],[0,1],[1,1]]},"base-node")},A=e=>{e.registerBehavior("canvas-event",{getDefaultCfg:()=>({}),shouldBegin:e=>!0,getEvents:()=>({"canvas:mousemove":"onCanvasMouseMove","canvas:mousedown":"onCanvasMouseDown","canvas:mouseup":"onCanvasMouseUp","canvas:dragend":"onCanvasDragEnd"}),onCanvasMouseMove(e){e.target.get("el").style.cursor="grab"},onCanvasMouseDown(e){e.target.get("el").style.cursor="grabbing"},onCanvasMouseUp(e){e.target.get("el").style.cursor="grab"},onCanvasDragEnd(e){e.target.get("el").style.cursor="grab",this.graph.emit("on-canvas-dragend",e)}})},k=e=>{e.registerBehavior("select-node",{getDefaultCfg:()=>({multiple:!1}),getEvents:()=>({"node:click":"onNodeClick","node:dblclick":"ondblClick","canvas:click":"onCanvasClick","node:mouseenter":"onNodeMouseEnter","node:mousemove":"onNodeMouseMove","node:mouseleave":"onNodeMouseLeave"}),shouldBegin:e=>!0,onNodeClick(e){this.shouldBegin(e)&&(this._clearSelected(),e.item.toFront(),e.item.setState("nodeState","selected"),this.graph.emit("after-node-selected",e))},ondblClick(e){this.shouldBegin(e)&&(this._clearSelected(),e.item.toFront(),e.item.setState("nodeState","selected"),this.graph.emit("after-node-dblclick",e))},onCanvasClick(e){this.shouldBegin(e)&&(this._clearSelected(),this.graph.emit("on-canvas-click",e))},onNodeMouseEnter(e){this.shouldBegin(e)&&(e.item.hasState("nodeState:selected")||e.item.setState("nodeState","hover"),this.graph.emit("on-node-mouseenter",e))},onNodeMouseMove(e){this.shouldBegin(e)&&this.graph.emit("on-node-mousemove",e)},onNodeMouseLeave(e){this.shouldBegin(e)&&(e.item.hasState("nodeState:selected")||e.item.clearStates("nodeState:hover"),this.graph.emit("on-node-mouseleave",e))},_clearSelected(){this.graph.findAllByState("node","nodeState:selected").forEach(e=>{e.clearStates(["nodeState:selected","nodeState:hover"])});this.graph.findAllByState("edge","edgeState:selected").forEach(e=>{e.clearStates(["edgeState:selected","edgeState:hover"])}),this.graph.emit("after-node-selected")}})},C=e=>{e.registerBehavior("delete-item",{getEvents:()=>({keydown:"onKeydown"}),shouldBegin:e=>!0,onKeydown(e){const{graph:t}=this;if("true"===t.cfg.canvas.cfg.el.getAttribute("isFocused")&&this.shouldBegin(e)&&(8===e.keyCode||46===e.keyCode)){const e=t.findAllByState("node","nodeState:selected");if(e&&e.length){const a=e[0].getContainer().get("item");t.emit("before-node-removed",{target:a,callback(e){e&&(t.remove(a),t.set("after-node-selected",[]),t.emit("after-node-selected"),t.emit("after-node-removed",a))}})}const a=t.findAllByState("edge","edgeState:selected");if(a&&a.length){const e=a[0].getContainer().get("item");t.emit("before-edge-removed",{target:e,callback(a){a&&(t.remove(e),t.set("after-edge-selected",[]),t.emit("after-edge-selected"),t.emit("after-edge-removed",e))}})}}}})},M=e=>{e.registerBehavior("active-edge",{getDefaultCfg:()=>({}),getEvents:()=>({"canvas:click":"onCanvasClick","edge:click":"onEdgeClick","edge:dblclick":"ondblEdgeClick","edge:mouseenter":"onMouseEnter","edge:mousemove":"onMouseMove","edge:mouseleave":"onMouseLeave"}),shouldBegin:e=>!0,onCanvasClick(e){this._clearSelected()},onEdgeClick(e){this.shouldBegin(e)&&(this._clearSelected(),e.item.setState("edgeState","selected"),this.graph.emit("after-edge-selected",e))},ondblEdgeClick(e){this.shouldBegin(e)&&(this._clearSelected(),e.item.setState("edgeState","selected"),this.graph.emit("after-edge-dblclick",e))},onMouseEnter(e){this.shouldBegin(e)&&(e.item.hasState("edgeState:hover")||e.item.hasState("edgeState:selected")||e.item.setState("edgeState","hover"),this.graph.emit("on-edge-mouseenter",e))},onMouseMove(e){this.shouldBegin(e)&&this.graph.emit("on-edge-mousemove",e)},onMouseLeave(e){this.shouldBegin(e)&&(e.item.hasState("edgeState:selected")||e.item.setState("edgeState","default"),this.graph.emit("on-edge-mouseleave",e))},_clearSelected(){this.graph.findAllByState("node","nodeState:selected").forEach(e=>{e.clearStates("nodeState:selected")});this.graph.findAllByState("edge","edgeState:selected").forEach(e=>{e.clearStates("edgeState:selected")}),this.graph.emit("after-edge-selected")}})},B=e=>{e.registerBehavior("hover-node",{getEvents:()=>({"node:mouseenter":"onNodeEnter","node:mouseleave":"onNodeLeave"}),shouldBegin:e=>!0,onNodeEnter(e){this.shouldBegin(e)&&e.item.setState("anchorShow",!0)},onNodeLeave(e){this.shouldBegin(e)&&e.item.setState("anchorShow",!1)}})},N=e=>{e.registerBehavior("drag-shadow-node",{getDefaultCfg:()=>({isGragging:!1,sourceAnchorIndex:0,dragTarget:"node",dragStartNode:{},distance:[]}),getEvents:()=>({"node:mousedown":"onMousedown","node:mouseup":"onMouseup","node:dragstart":"onDragStart","node:drag":"onDrag","node:dragend":"onDragEnd","node:drop":"onDrop"}),shouldBegin:e=>!0,onMousedown(e){if(this.shouldBegin(e)){if(this._clearSelected(e),e.target.cfg.isAnchor){this.dragTarget="anchor",this.dragStartNode={...e.item._cfg,anchorIndex:e.target.cfg.index};this.graph.findAll("node",e=>e).forEach(e=>{e.setState("anchorActived",!0)})}this.graph.emit("on-node-mousedown",e)}},onMouseup(e){if(this.shouldBegin(e)){if("anchor"===this.dragTarget){this.graph.findAll("node",e=>e).forEach(e=>{e.clearStates("anchorActived")})}this.graph.emit("on-node-mouseup",e)}},onDragStart(e){if(!this.shouldBegin(e))return;const t=e.item.getContainer();this.isGragging=!0,this.origin={x:e.x,y:e.y},e.target.get("isAnchor")?this.sourceAnchorIndex=e.target.get("index"):t.getFirst().cfg.xShapeNode&&(e.item.toFront(),this.dragTarget="node",this._nodeOnDragStart(e,t)),this.graph.emit("on-node-dragstart",e)},onDrag(e){if(this.shouldBegin(e)&&this.isGragging){const t=e.item.getContainer();"node"===this.dragTarget&&t.getFirst().cfg.xShapeNode&&this._nodeOnDrag(e,e.item.getContainer()),this.graph.emit("on-node-drag",e)}},onDragEnd(e){if(!this.shouldBegin(e))return;const t=e.item.getContainer();if(this.isGragging=!1,"anchor"===this.dragTarget){this.graph.findAll("node",e=>e).forEach(e=>{e.clearStates("anchorActived")})}else"node"===this.dragTarget&&t.getFirst().cfg.xShapeNode&&this._nodeOnDragEnd(e,t);this.graph.emit("on-node-dragend",e)},onDrop(e){if(this.shouldBegin(e)){if(this.dragStartNode.id&&e.target.cfg.isAnchor&&this.dragStartNode.id!==e.target.cfg.nodeId){const t=this.dragStartNode.group.get("item"),{singleEdge:a}=t.getModel(),o=e.target.get("index");t.getOutEdges().find(n=>{if(n.get("source").get("id")===t.get("id")&&n.get("target").get("id")===e.target.cfg.nodeId&&n.get("sourceAnchorIndex")===this.sourceAnchorIndex&&n.get("targetAnchorIndex")===o||a&&n.get("target").get("id")===e.target.cfg.nodeId)return!0})||this.graph.emit("before-edge-add",{source:t,target:e.item.getContainer().get("item"),sourceAnchor:this.dragStartNode.anchorIndex,targetAnchor:e.target.cfg.index})}this.graph.emit("on-node-drop",e)}},_dragNodeModeCheck(){return!!this.graph.get("modes")[this.graph.getCurrentMode()].includes("drag-node")&&(console.warn("Behavior drag-shadow-node 与内置 Behavior drag-node 在行为上有冲突, 请考虑改用 setMode 来分开两种错误, 或在以上两种行为的入参 shouldBegin 方法中添加逻辑处理来避免冲突"),!0)},_nodeOnDragStart(e,t){this._dragNodeModeCheck(),this._addShadowNode(e,t)},_addShadowNode(e,t){const a=t.get("item"),o=a.get("model"),{radius:n}=a.get("originStyle"),r=a.get("currentShape"),{width:s,height:i,centerX:d,centerY:l}=a.getBBox(),h=a.get("shapeFactory")[r];let{shapeType:g}=h||{},c={fillOpacity:.1,fill:"#1890FF",stroke:"#1890FF",cursor:"move",lineDash:[4,4],width:s,height:i,x:o.x,y:o.y};switch(g){case"circle":this.distance=[e.x-d,e.y-l],c={...c,r:s/2};break;case"rect":this.distance=[e.x-d+s/2,e.y-l+i/2],c={...c,x:-s/2,y:-i/2,r:s/2},n&&(c.radius=n);break;case"ellipse":this.distance=[e.x-d,e.y-l],c={...c,rx:s/2,ry:i/2};break;case"path":this.distance=[e.x-d,e.y-l],c.path=a.get("keyShape").attrs.path,c.size=[s,i];break;case"modelRect":this.distance=[e.x-d+s/2,e.y-l+i/2],c={...c,x:-s/2,y:-i/2,r:s/2},g="rect";break;default:g="circle"}t.addShape(g,{className:"shadow-node",attrs:c}).toFront()},_nodeOnDrag(e,t){const a=t.get("item"),o=t.getFirst(),{width:n,height:r,centerX:s,centerY:i}=a.getBBox(),d=o.cfg.xShapeNode?t.$getItem("shadow-node"):null,l=a.get("shapeFactory")[a.get("currentShape")],{shapeType:h}=l||{};if(!d)return console.warn("暂未支持拖拽内置节点");if("path"===h){const{type:t,direction:a}=o.get("attrs"),l=e.x-s-this.distance[0],h=e.y-i-this.distance[1],g=[["Z"]];switch(t){case"diamond-node":g.unshift(["M",l,h-r/2],["L",l+n/2,h],["L",l,h+r/2],["L",l-n/2,h]);break;case"triangle-node":g.unshift(["L",l+n/2,h],["L",l-n/2,h]),"up"===a?g.unshift(["M",l,h-r]):g.unshift(["M",l,h+r])}d.attr({path:g})}else d.attr({x:e.x-s-this.distance[0],y:e.y-i-this.distance[1]});d.toFront()},_nodeOnDragEnd(e,t){const{graph:a}=this,o=e.item.getModel(),n=t.getFirst().cfg.xShapeNode?t.$getItem("shadow-node"):null;if(n){const t={x:e.x-this.origin.x+o.x,y:e.y-this.origin.y+o.y};n.remove(),this._dragNodeModeCheck()||a.updateItem(e.item,t)}},_clearSelected(e){this.graph.findAllByState("edge","edgeState:selected").forEach(e=>{e.clearStates(["edgeState:selected","edgeState:hover"])})}})};var F={ball:{run(e){const t=e.get("children")[0],a=t.get("endArrowShape"),o=a&&a.get("bbox")?Math.max(a.get("bbox").width,a.get("bbox").height):0,n=t.getPoint(0),r=t.getTotalLength(),s=Math.floor(r/100)||1;if(!(r<=40))for(let a=0;a<s;a++){const s=setTimeout(()=>{const a=e.addShape("circle",{attrs:{x:n.x,y:n.y,fill:"#1890ff",r:2},className:"edge-runner",name:"edge-runner"});a.animate(e=>{const n=t.getPoint(e),s=r-r*e>=o?1:0;return a.set("hasChanged",!1),{...n,opacity:s}},{duration:r>=100?3*r:5*r,repeat:!0})},a*r);e.runners.push(s)}},stop(e){const t=[];e.get("children").forEach(e=>{"edge-runner"===e.get("className")&&(e.stopAnimate(),t.push(e))}),t.forEach(e=>e.remove()),e.runners.forEach(e=>{clearTimeout(e)}),e.running=!1}},dash:{run(e){let t=0;const a=e.get("children")[0];e.addShape("path",{attrs:{offset:a.attrs.offset,path:a.attrs.path,stroke:"#fff",startArrow:!1,endArrow:!1},name:"edge-dash"}).animate(e=>(t++,t>9&&(t=0),{lineDash:[2,1,2,4],lineDashOffset:-t}),{repeat:!0,duration:3e3})},stop(e){const t=e.get("children").find(e=>"edge-dash"===e.cfg.name);t&&(t.remove(),e.running=!1)}}};
/*!
 * @author claude
 * date 06/09/2020
 * 注册边
 */function L(e,t){t.running=!1,t.runners=[];const a=Object.assign({},this.getShapeStyle(e),{...e.edgeStateStyles});return t.addShape("path",{className:"edge-shape",name:"edge-shape",attrs:a})}function E(e,t,a){const o=a.getContainer();o.get("destroyed")||(["edgeState","edgeState:default","edgeState:selected","edgeState:hover"].includes(e)?s[e].call(this,t,o):this.stateApplying?this.stateApplying.call(this,e,t,a):console.warn(`warning: edge ${e} 事件回调未注册!`))}function I(e,t){e.running||(e.running=!0,e.toFront(),F[t].run.call(this,e))}function P(e,t){F[t].stop.call(this,e)}var T=e=>{["line","polyline","quadratic","cubic","arc"].forEach(t=>{!function(e,t){e.registerEdge(t+"-edge",{drawShape:L,setState:E,runAnimate:I,stopAnimate:P},t)}(e,t)}),((e,t)=>{e.registerEdge("hvh-edge",{draw(e,t){const{startPoint:a,endPoint:o}=e,n=o.y-a.y,r={x:a.x,y:o.y},s=0===n?[["M",a.x,a.y],["L",o.x,o.y]]:[["M",a.x,a.y],["L",a.x+40,a.y],["L",r.x+40,o.y>a.y?r.y-10:r.y+10],["Q",r.x+40,r.y,r.x+40+10,r.y],["L",o.x,o.y]],{edgeStyle:i}=e.sourceNode.getModel(),d=t.addShape("path",{attrs:{path:s,stroke:"#1890FF",endArrow:!1,...e.style,...i},name:"hvh-edge",draggable:!0}),{note:l}=e.targetMode.getModel();if(l){const e=t.addShape("text",{attrs:{x:r.x+40+10,y:o.y-30,autoRotate:!0,text:l||"",fill:"#333",stroke:"#fff",fontSize:16},zIndex:10});t.sort(),e.toFront()}return d},...t})})(e,{drawShape:L,setState:E,runAnimate:I,stopAnimate:P}),((e,t)=>{e.registerEdge("hvh-h-edge",{draw(e,t){const{startPoint:a,endPoint:o}=e,n=o.y-a.y,r={x:a.x,y:o.y},s=a.x-o.x>0,i=0===n?[["M",a.x,a.y],["L",o.x,o.y]]:[["M",a.x,a.y],["L",s?a.x-40:a.x+40,a.y],["L",s?r.x-40:r.x+40,o.y>a.y?r.y-10:r.y+10],["Q",s?r.x-40:r.x+40,r.y,s?r.x-40-10:r.x+40+10,r.y],["L",o.x,o.y]],{edgeStyle:d}=e.sourceNode.getModel(),l=t.addShape("path",{attrs:{path:i,stroke:"#1890FF",endArrow:!1,...e.style,...d},name:"hvh-edge",draggable:!0}),{text:h}=e.targetNode.getModel();if(h){const e=t.addShape("text",{attrs:{x:r.x+40+10,y:o.y-30,text:h||"",fill:"#333",fontSize:16},name:"hvh-edge-label",zIndex:10});t.sort(),e.toFront()}return l},...t})})(e,{drawShape:L,setState:E,runAnimate:I,stopAnimate:P})},D=e=>{(e=>{y(e),w(e)})(e),(e=>{A(e),k(e),C(e),M(e),B(e),N(e)})(e),T(e)};t.default=(e,t)=>{const a=Object.assign({container:"canvasPanel",width:window.innerWidth,height:window.innerHeight,fitViewPadding:20,animate:!0,animateCfg:{duration:500,easing:"easeLinear"},layout:{type:"dagre",nodesep:30,ranksep:30},modes:{default:["drag-canvas","canvas-event","delete-item","select-node","hover-node","drag-shadow-node","active-edge"]},defaultNode:{type:"rect-node",style:{radius:10}},defaultEdge:{type:"polyline-edge",style:{radius:6,offset:15,stroke:"#aab7c3",lineAppendWidth:10,endArrow:{path:"M 0,0 L 8,4 L 7,0 L 8,-4 Z",fill:"#aab7c3",stroke:"#aab7c3"}}},nodeStateStyles:{"nodeState:default":{fill:"#E7F7FE",stroke:"#1890FF"},"nodeState:hover":{fill:"#d5f1fd"},"nodeState:selected":{fill:"#caebf9",stroke:"#1890FF"}},edgeStateStyles:{"edgeState:default":{stroke:"#aab7c3",endArrow:{path:"M 0,0 L 8,4 L 7,0 L 8,-4 Z",fill:"#aab7c3",stroke:"#aab7c3"}},"edgeState:selected":{stroke:"#1890FF"},"edgeState:hover":{stroke:"#1890FF"}}},t),o="string"==typeof a.container?document.getElementById(a.container):a.container;return o?(setTimeout(()=>{for(let e=0;e<o.children.length;e++){const t=o.children[e];if("CANVAS"===t.nodeName){t.$id=a.container+"-canvas",document.addEventListener("click",e=>{t.setAttribute("isFocused",e.target.$id===t.$id)});break}}}),D(e)):console.warn("未找到注册节点!"),a}}])}));